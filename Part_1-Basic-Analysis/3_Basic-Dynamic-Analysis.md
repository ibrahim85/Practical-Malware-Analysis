#### 3. Basic Dynamic Analysis

###### Sandboxes

- Norman SandBox
- GFI Sandbox
- Anubis
- Joe Sandbox
- ThreatExpert
- BitBlaze
- Comodo Instant Malware Analysis

Usual analysis leads to 

- Analysis Summary
- File Activity
- Created Mutexes
- Registry Activity
- Network Activity
- VirusTotal Results

###### Running Malware

- Run DLL

```sh
C:\>rundll32.exe DLLname, Export arguments
```

View exports of a DLL - PEview, PE Explorer 

```sh
C:\>rundll32.exe rip.dll, Install
```

Where ```Install``` is one of the exports

```shC:\>rundll32.exe xyzzy.dll, #5
```

where ```5``` is the ordinal number that you want to call, prepended with the # character

- Convert a ```DLL``` into an ```EXE```

Remove the ```IMAGE_FILE_DLL``` (```0x2000```) flag from the Characteristics field in the ```IMAGE_FILE_HEADER```

This will cause the ```DLLMain``` method to run.

![Image of DLL2EXE](images/15.jpeg)

![Image of DLL2EXE](images/11.jpeg)

![Image of DLL2EXE](images/12.jpeg)

![Image of DLL2EXE](images/13.jpeg)

![Image of DLL2EXE](images/14.jpeg)

![Image of DLL2EXE](images/16.jpeg)

- Install DLL malware as a service

DLL malware may also need to be installed as a service

```shC:\>rundll32.exe ipr32x.dll,InstallService ServiceName 
C:\>net start ServiceName
```Where ```InstallService``` is an export. The ```ServiceName``` argument must be provided to the malware so it can be installed and run. The ```net start``` command is used to start a service on a Windows system. 

**When you see a ```ServiceMain``` function without a convenient exported function such as ```Install``` or ```InstallService```, you may need to install the service manually. You can do this by using the Windows ``sc`` command or by modifying the registry for an unused service, and then using ```net start``` on that service. The service entries are located in the registry at ```HKLM\SYSTEM\CurrentControlSet\Services```.**

###### Monitoring with Process Monitor

- Does not capture

	- Device driver activity of a user-mode component talking to a rootkit via device I/O controls
	- GUI calls, such as ```SetWindowsHookEx```
	- Network activity
	
	![Image of DLL2EXE](images/17.jpeg)

- Stop procmon from capturing events

	File &rarr; Capture Events- Clear displays

	Edit &rarr; Clear Display
	
- Detailed View
	
	![Image of DLL2EXE](images/18.jpeg)
	
- Filtering
	
	![Image of DLL2EXE](images/19.jpeg)
	
	Filter &rarr; Filter - Important Filters - ```Process Name, Operation, and Detail```
	
- Enable boot logging
	
	![Image of DLL2EXE](images/20.jpeg)
	
![Image of DLL2EXE](images/21.jpeg)

###### Viewing Processes with Process Explorer

![Image of DLL2EXE](images/22.jpeg)
	
	Type | Color
	-----|----------
	Services | Pink
	Processes | Blue
	New processes | Green
	Terminated processes | Red

- Verify Option

	![Image of DLL2EXE](images/23.jpeg)
	
	The Verify button verifies the image on disk rather than in memory,and it is useless if an attacker uses ``process replacement``, which involves running a process on the system and overwriting its memory space with a malicious executable.

- Comparing Strings

	Used to identify ``process replacement``
	
	![Image of DLL2EXE](images/24.jpeg)
	
	If the strings in memory and image are drastically different then ``process replacement`` may have occurred
	
	![Image of DLL2EXE](images/25.jpeg)
	
	You can also use Process Explorer to analyze malicious documents, such as PDFs and Word documents. A quick way to determine whether a document is malicious is to open Process Explorer and then open the suspected malicious document. If the document launches any processes, you should see them in Process Explorer, and be able to locate the malware on disk via the Image tab of the Properties window.
	
- Comparing Registry Snapshots with Regshot

	1st shot &rarr; 2nd shot &rarr; Compare
	
	![Image of DLL2EXE](images/26.jpeg)
	
	![Image of DLL2EXE](images/27.jpeg)
	
	![Image of DLL2EXE](images/28.jpeg)
	
- Faking a Network

	